<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CatBug">
  <meta name="theme-color" content="#1a3a1a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>CatBug - Katzenspiel</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
    html,body{height:100%;overflow:hidden;background:#1a3a1a}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif}

    /* --- Grass canvas --- */
    #grassCanvas{position:fixed;inset:0;z-index:0}

    /* --- Bug --- */
    #bug{position:absolute;z-index:5;pointer-events:none;transition:none}
    /* Foreground grass layer on top of bug */
    #grassFgCanvas{position:fixed;inset:0;z-index:10;pointer-events:none}

    .bug-body{fill:var(--bug-body,#4a3728)}.bug-head{fill:var(--bug-head,#3a2a1c)}
    .bug-legs{stroke:var(--bug-dark,#3a2a1c);stroke-width:1.5;fill:none;stroke-linecap:round}
    .bug-antenna{stroke:var(--bug-dark,#3a2a1c);stroke-width:1;fill:none;stroke-linecap:round}
    .bug-eye{fill:#111}.bug-shell-line{stroke:var(--bug-line,#3a2a1c);stroke-width:0.8;fill:none}
    .bug-shine{fill:rgba(255,255,255,0.12)}
    .bug-dot{fill:#fff}

    @keyframes lw1{0%,100%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}}
    @keyframes lw2{0%,100%{transform:rotate(8deg)}50%{transform:rotate(-8deg)}}
    .leg-group-1{animation:lw1 .2s infinite}
    .leg-group-2{animation:lw2 .2s infinite}
    .legs-paused .leg-group-1,.legs-paused .leg-group-2{animation-play-state:paused}

    /* --- Splat --- */
    #splat{position:absolute;z-index:8;pointer-events:none;opacity:0;transition:opacity .3s}
    #splat.visible{opacity:1}
    .splat-shape{fill:var(--splat-color,#3a2a1c)}

    /* --- Tap zone (over foreground grass) --- */
    #tapZone{position:fixed;inset:0;z-index:15}

    /* --- Settings button --- */
    #settingsBtn{position:fixed;top:max(12px,env(safe-area-inset-top));right:max(12px,env(safe-area-inset-right));width:36px;height:36px;background:none;border:none;color:rgba(255,255,255,0.25);cursor:pointer;z-index:50;padding:4px;transition:color .2s}
    #settingsBtn:active{color:rgba(255,255,255,0.5)}
    #settingsBtn svg{width:100%;height:100%}

    /* --- Settings overlay --- */
    #settings{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #settings.visible{opacity:1;pointer-events:auto}
    .settings-card{width:85%;max-width:340px;background:#1a2a1a;border-radius:20px;padding:32px 24px;border:1px solid #2a4a2a}
    .settings-title{color:#fff;font-size:20px;font-weight:600;text-align:center;margin-bottom:32px}
    .setting-group{margin-bottom:28px}
    .setting-label{display:flex;justify-content:space-between;align-items:center;color:#aaa;font-size:14px;margin-bottom:10px}
    .setting-value{color:#fff;font-weight:600;font-variant-numeric:tabular-nums}
    input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:#2a4a2a;outline:none}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;cursor:pointer}
    .close-btn{display:block;width:100%;padding:16px;margin-top:8px;background:#2a4a2a;border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;font-family:inherit;cursor:pointer}
    .close-btn:active{background:#3a5a3a}

    /* --- Score --- */
    #score{position:fixed;top:max(16px,env(safe-area-inset-top));left:max(16px,env(safe-area-inset-left));color:rgba(255,255,255,0.3);font-size:14px;font-weight:600;z-index:50;font-variant-numeric:tabular-nums}
  </style>
</head>
<body>

  <!-- Background grass (behind bug) -->
  <canvas id="grassCanvas"></canvas>

  <!-- Bug -->
  <div id="bug">
    <svg viewBox="0 0 40 50" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="rainbow" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#ff0000"/>
          <stop offset="20%" stop-color="#ff8800"/>
          <stop offset="40%" stop-color="#ffff00"/>
          <stop offset="60%" stop-color="#00cc44"/>
          <stop offset="80%" stop-color="#0088ff"/>
          <stop offset="100%" stop-color="#aa00ff"/>
        </linearGradient>
      </defs>
      <path class="bug-antenna" d="M16 14 Q12 4 8 2"/>
      <path class="bug-antenna" d="M24 14 Q28 4 32 2"/>
      <g class="leg-group-1" style="transform-origin:14px 28px">
        <path class="bug-legs" d="M14 22 Q6 18 3 15"/>
        <path class="bug-legs" d="M14 36 Q6 40 3 43"/>
      </g>
      <g class="leg-group-2" style="transform-origin:14px 28px">
        <path class="bug-legs" d="M14 28 Q5 28 2 26"/>
      </g>
      <g class="leg-group-2" style="transform-origin:26px 28px">
        <path class="bug-legs" d="M26 22 Q34 18 37 15"/>
        <path class="bug-legs" d="M26 36 Q34 40 37 43"/>
      </g>
      <g class="leg-group-1" style="transform-origin:26px 28px">
        <path class="bug-legs" d="M26 28 Q35 28 38 26"/>
      </g>
      <ellipse class="bug-body" cx="20" cy="30" rx="9" ry="12"/>
      <line class="bug-shell-line" x1="20" y1="19" x2="20" y2="42"/>
      <g id="bugDots"></g>
      <ellipse class="bug-shine" cx="17" cy="26" rx="3" ry="5" transform="rotate(-15 17 26)"/>
      <circle class="bug-head" cx="20" cy="16" r="6"/>
      <circle class="bug-eye" cx="18" cy="15" r="1.2"/>
      <circle class="bug-eye" cx="22" cy="15" r="1.2"/>
    </svg>
  </div>

  <!-- Splat effect -->
  <div id="splat">
    <svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
      <circle class="splat-shape" cx="30" cy="30" r="8" opacity="0.7"/>
      <ellipse class="splat-shape" cx="22" cy="22" rx="5" ry="3" opacity="0.5" transform="rotate(-30 22 22)"/>
      <ellipse class="splat-shape" cx="40" cy="24" rx="4" ry="2.5" opacity="0.4" transform="rotate(20 40 24)"/>
      <ellipse class="splat-shape" cx="24" cy="38" rx="4" ry="2" opacity="0.45" transform="rotate(10 24 38)"/>
      <ellipse class="splat-shape" cx="38" cy="36" rx="3" ry="2" opacity="0.35" transform="rotate(-15 38 36)"/>
      <circle class="splat-shape" cx="18" cy="30" r="2" opacity="0.3"/>
      <circle class="splat-shape" cx="42" cy="30" r="1.5" opacity="0.25"/>
    </svg>
  </div>

  <!-- Foreground grass (over bug) -->
  <canvas id="grassFgCanvas"></canvas>

  <!-- Tap zone -->
  <div id="tapZone"></div>

  <!-- Score -->
  <div id="score">0</div>

  <!-- Settings button -->
  <button id="settingsBtn" aria-label="Einstellungen">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </button>

  <!-- Settings overlay -->
  <div id="settings">
    <div class="settings-card">
      <div class="settings-title">Einstellungen</div>
      <div class="setting-group">
        <div class="setting-label">
          <span>Geschwindigkeit</span>
          <span class="setting-value" id="speedValue">50%</span>
        </div>
        <input type="range" id="speedSlider" min="10" max="100" value="50">
      </div>
      <div class="setting-group">
        <div class="setting-label">
          <span>Gr&ouml;&szlig;e</span>
          <span class="setting-value" id="sizeValue">50%</span>
        </div>
        <input type="range" id="sizeSlider" min="20" max="100" value="50">
      </div>
      <button class="close-btn" id="closeSettings">Fertig</button>
    </div>
  </div>

  <script>
    // --- Settings ---
    const SETTINGS_KEY = 'catbug_settings';
    const defaults = { speed: 50, size: 50 };
    let settings = Object.assign({}, defaults, JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'));

    const speedSlider = document.getElementById('speedSlider');
    const sizeSlider = document.getElementById('sizeSlider');
    const speedValue = document.getElementById('speedValue');
    const sizeValue = document.getElementById('sizeValue');
    const settingsEl = document.getElementById('settings');

    function applySettings() {
      speedSlider.value = settings.speed;
      sizeSlider.value = settings.size;
      speedValue.textContent = settings.speed + '%';
      sizeValue.textContent = settings.size + '%';
      updateBugSize();
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    speedSlider.addEventListener('input', () => {
      settings.speed = parseInt(speedSlider.value);
      applySettings();
    });
    sizeSlider.addEventListener('input', () => {
      settings.size = parseInt(sizeSlider.value);
      applySettings();
    });

    document.getElementById('settingsBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      settingsEl.classList.add('visible');
    });
    document.getElementById('closeSettings').addEventListener('click', () => {
      settingsEl.classList.remove('visible');
    });

    // --- Grass rendering ---
    const bgCanvas = document.getElementById('grassCanvas');
    const fgCanvas = document.getElementById('grassFgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const fgCtx = fgCanvas.getContext('2d');

    let W, H, grassBlades = [];
    const BLADE_DENSITY = 0.015; // blades per square pixel

    function initGrass() {
      W = window.innerWidth;
      H = window.innerHeight;
      const dpr = window.devicePixelRatio || 1;
      bgCanvas.width = fgCanvas.width = W * dpr;
      bgCanvas.height = fgCanvas.height = H * dpr;
      bgCanvas.style.width = fgCanvas.style.width = W + 'px';
      bgCanvas.style.height = fgCanvas.style.height = H + 'px';
      bgCtx.scale(dpr, dpr);
      fgCtx.scale(dpr, dpr);

      grassBlades = [];
      const count = Math.floor(W * H * BLADE_DENSITY);
      for (let i = 0; i < count; i++) {
        grassBlades.push({
          x: Math.random() * W,
          y: Math.random() * H,
          h: 12 + Math.random() * 22,       // height
          w: 1.5 + Math.random() * 2,        // width
          bend: 0,                            // current bend from bug
          baseBend: (Math.random() - 0.5) * 0.3, // natural slight bend
          hue: 90 + Math.random() * 40,      // green variation
          lightness: 18 + Math.random() * 18, // dark greens
          fg: Math.random() < 0.35,          // 35% foreground (on top of bug)
          phase: Math.random() * Math.PI * 2  // wind phase
        });
      }
    }

    function drawGrass(ctx, fgLayer, time) {
      ctx.clearRect(0, 0, W, H);
      if (!fgLayer) {
        ctx.fillStyle = '#1a3a1a';
        ctx.fillRect(0, 0, W, H);
      }

      const wind = Math.sin(time * 0.001) * 0.15;

      for (const b of grassBlades) {
        if (b.fg !== fgLayer) continue;

        // Bend decays
        b.bend *= 0.94;

        const totalBend = b.baseBend + b.bend + wind + Math.sin(time * 0.002 + b.phase) * 0.05;
        const tipX = b.x + Math.sin(totalBend) * b.h;
        const tipY = b.y - b.h;

        ctx.beginPath();
        ctx.moveTo(b.x - b.w / 2, b.y);
        ctx.quadraticCurveTo(b.x + Math.sin(totalBend) * b.h * 0.5, b.y - b.h * 0.6, tipX, tipY);
        ctx.quadraticCurveTo(b.x + Math.sin(totalBend) * b.h * 0.5 + b.w, b.y - b.h * 0.6, b.x + b.w / 2, b.y);
        ctx.closePath();

        const l = b.lightness + (fgLayer ? 4 : 0);
        ctx.fillStyle = `hsl(${b.hue}, 60%, ${l}%)`;
        ctx.fill();
      }
    }

    function pushGrassNearBug(bx, by, radius) {
      const r2 = radius * radius;
      for (const b of grassBlades) {
        const dx = b.x - bx;
        const dy = b.y - by;
        const d2 = dx * dx + dy * dy;
        if (d2 < r2) {
          const strength = 1 - Math.sqrt(d2) / radius;
          const pushDir = dx > 0 ? 1 : -1;
          b.bend += pushDir * strength * 0.4;
        }
      }
    }

    // --- Bug ---
    const bugEl = document.getElementById('bug');
    const bugSvg = bugEl.querySelector('svg');
    const splatEl = document.getElementById('splat');
    const scoreEl = document.getElementById('score');

    let bugX, bugY, angle, targetX, targetY;
    let paused = false, pauseTimer = 0;
    let dead = false, respawnTimer = 0;
    let bugVariant = 0; // 0 = ladybug (red), 1 = rainbow

    const VARIANTS = [
      { // Ladybug: red with white dots
        body: '#cc2222', head: '#1a1a1a', dark: '#1a1a1a', line: '#8b0000',
        splat: '#cc2222',
        dots: true
      },
      { // Rainbow bug
        body: 'url(#rainbow)', head: '#2a1a3a', dark: '#2a1a3a', line: 'rgba(0,0,0,0.3)',
        splat: '#8844cc',
        dots: false
      }
    ];

    function applyVariant(v) {
      const s = bugEl.style;
      s.setProperty('--bug-body', v.body);
      s.setProperty('--bug-head', v.head);
      s.setProperty('--bug-dark', v.dark);
      s.setProperty('--bug-line', v.line);
      // Dots
      const dotsG = document.getElementById('bugDots');
      if (v.dots) {
        dotsG.innerHTML =
          '<circle class="bug-dot" cx="16" cy="25" r="1.5"/>' +
          '<circle class="bug-dot" cx="24" cy="25" r="1.5"/>' +
          '<circle class="bug-dot" cx="15" cy="32" r="1.3"/>' +
          '<circle class="bug-dot" cx="25" cy="32" r="1.3"/>' +
          '<circle class="bug-dot" cx="17" cy="38" r="1.1"/>' +
          '<circle class="bug-dot" cx="23" cy="38" r="1.1"/>';
      } else {
        dotsG.innerHTML = '';
      }
    }
    let score = parseInt(localStorage.getItem('catbug_score') || '0');
    scoreEl.textContent = score;

    function updateBugSize() {
      const s = 30 + (settings.size / 100) * 70;
      bugEl.style.width = s + 'px';
      bugEl.style.height = (s * 1.25) + 'px';
    }

    function getSpeed() {
      return 0.5 + (settings.speed / 100) * 3.5;
    }

    function getBugRadius() {
      return (30 + (settings.size / 100) * 70) / 2;
    }

    function pickTarget() {
      const overflow = 60;
      targetX = -overflow + Math.random() * (W + overflow * 2);
      targetY = -overflow + Math.random() * (H + overflow * 2);
    }

    function spawnBug() {
      // Alternate variant
      bugVariant = (bugVariant + 1) % VARIANTS.length;
      applyVariant(VARIANTS[bugVariant]);

      // Spawn at random edge
      const edge = Math.floor(Math.random() * 4);
      if (edge === 0) { bugX = -30; bugY = Math.random() * H; }
      else if (edge === 1) { bugX = W + 30; bugY = Math.random() * H; }
      else if (edge === 2) { bugX = Math.random() * W; bugY = -30; }
      else { bugX = Math.random() * W; bugY = H + 30; }
      angle = Math.atan2(H / 2 - bugY, W / 2 - bugX);
      pickTarget();
      dead = false;
      bugEl.style.display = '';
      bugSvg.classList.remove('legs-paused');
    }

    function splatBug(tx, ty) {
      dead = true;
      bugEl.style.display = 'none';

      // Splat color matches current variant
      splatEl.style.setProperty('--splat-color', VARIANTS[bugVariant].splat);

      // Show splat
      const ss = getBugRadius() * 2.5;
      splatEl.style.width = ss + 'px';
      splatEl.style.height = ss + 'px';
      splatEl.style.transform = `translate(${bugX - ss/2}px, ${bugY - ss/2}px)`;
      splatEl.classList.add('visible');

      score++;
      scoreEl.textContent = score;
      localStorage.setItem('catbug_score', score);

      // Respawn after delay
      respawnTimer = 90 + Math.random() * 60;
    }

    // --- Tap handling ---
    document.getElementById('tapZone').addEventListener('click', (e) => {
      if (settingsEl.classList.contains('visible')) return;
      if (dead) return;

      const tx = e.clientX;
      const ty = e.clientY;
      const dx = tx - bugX;
      const dy = ty - bugY;
      const hitRadius = getBugRadius() * 1.5;

      if (dx * dx + dy * dy < hitRadius * hitRadius) {
        splatBug(tx, ty);
      }
    });

    // --- Main loop ---
    function init() {
      initGrass();
      bugX = W / 2;
      bugY = H / 2;
      angle = Math.random() * Math.PI * 2;
      pickTarget();
      applyVariant(VARIANTS[bugVariant]);
      applySettings();
      requestAnimationFrame(loop);
    }

    function loop(time) {
      if (!settingsEl.classList.contains('visible')) {
        if (dead) {
          respawnTimer--;
          if (respawnTimer <= 0) {
            splatEl.classList.remove('visible');
            spawnBug();
          }
        } else if (paused) {
          pauseTimer--;
          if (pauseTimer <= 0) {
            paused = false;
            bugSvg.classList.remove('legs-paused');
            pickTarget();
          }
        } else {
          const dx = targetX - bugX;
          const dy = targetY - bugY;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < 5) {
            if (Math.random() < 0.4) {
              paused = true;
              pauseTimer = 30 + Math.random() * 90;
              bugSvg.classList.add('legs-paused');
            } else {
              pickTarget();
            }
          } else {
            const ta = Math.atan2(dy, dx);
            let ad = ta - angle;
            while (ad > Math.PI) ad -= Math.PI * 2;
            while (ad < -Math.PI) ad += Math.PI * 2;
            angle += ad * 0.08;

            const spd = getSpeed();
            bugX += Math.cos(angle) * spd;
            bugY += Math.sin(angle) * spd;
          }

          // Push grass
          pushGrassNearBug(bugX, bugY, getBugRadius() * 1.8);

          // Position bug
          const bw = bugEl.offsetWidth;
          const bh = bugEl.offsetHeight;
          const rot = (angle * 180 / Math.PI) + 90;
          bugEl.style.transform = `translate(${bugX - bw/2}px, ${bugY - bh/2}px) rotate(${rot}deg)`;
        }

        // Draw grass layers
        drawGrass(bgCtx, false, time);
        drawGrass(fgCtx, true, time);
      }

      requestAnimationFrame(loop);
    }

    window.addEventListener('resize', initGrass);
    init();

    // --- Keep screen on ---
    let noSleepVideo = null;
    function createVideo() {
      const mp4 = 'AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAA'
        + 'OBtZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlID'
        + 'E0OCByMjY0MyA1YzY1NzA0IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyA'
        + 'tIENvcHlsZWZ0IDIwMDMtMjAxNSAtIGh0dHA6Ly93d3cudmlkZW9sYW4u'
        + 'b3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVib'
        + 'G9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9Ny'
        + 'Bwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3Jhbmd'
        + 'lPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBk'
        + 'ZWFkem9uZT0yMSwyMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNld'
        + 'D0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdG'
        + 'hyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF'
        + '5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJf'
        + 'cHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlna'
        + 'HRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbn'
        + 'RfbWluPTEwIHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29'
        + 'rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAu'
        + 'NjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwI'
        + 'GFxPTE6MS4wMAAAAAADaWllYXMAAAAA/2QBZN/hAAAAC3Rya24AAABcZWR0'
        + 'cwAAABRlbHN0AAAAAAAAAAEAAAAAAAAAFHNraXAAAAAIZnJlZQAAAAhtZGF0'
        + 'AAAAMm1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAAAAQA'
        + 'AAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAA'
        + 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAmHRyYWsAAABcdGt'
        + 'oZAAAAA8AAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAA'
        + 'AAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAABAAAAAAAAAAAAADAAFN'
        + 'AAAB0bWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAADIAAAACAFXEAAAAAAAtaGR'
        + 'scgAAAAAAAAAAc291bgAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx'
        + '1cmwgAAAAAQAAAChzdGJsAAAAGHN0c2QAAAAAAAAAAQAAAA8AAAAAAAAAAA'
        + 'AUc3RzegAAAAAAAAAAAAAUc3RjbwAAAAAAAAAA';
      const bin = atob(mp4);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      const v = document.createElement('video');
      v.setAttribute('playsinline', '');
      v.setAttribute('muted', '');
      v.setAttribute('loop', '');
      v.muted = true;
      v.style.cssText = 'position:fixed;top:-1px;left:-1px;width:1px;height:1px;opacity:0.01';
      v.src = URL.createObjectURL(new Blob([bytes], { type: 'video/mp4' }));
      return v;
    }
    function startVideo() {
      if (!noSleepVideo) { noSleepVideo = createVideo(); document.body.appendChild(noSleepVideo); }
      noSleepVideo.play().catch(() => {});
    }
    startVideo();
    document.addEventListener('click', () => { if (noSleepVideo && noSleepVideo.paused) startVideo(); });
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') startVideo(); });

    // --- Register service worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>
